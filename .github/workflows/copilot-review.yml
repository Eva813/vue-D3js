name: Copilot Automated Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/agents/**'
      - '.github/workflows/copilot-review.yml'
      - '.github/copilot-audit.json'
      - 'scripts/vulnerability-scan.js'
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/agents/**'
      - '.github/workflows/copilot-review.yml'
      - '.github/copilot-audit.json'
      - 'scripts/vulnerability-scan.js'

env:
  NODE_VERSION: '20'
  COPILOT_MODEL: 'gpt-5.1-codex'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  quality-checks:
    name: Type check, lint, and tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack and install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@9.12.3 --activate

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store/v3
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        run: pnpm lint

      - name: Run unit tests
        run: pnpm test:run

      - name: Build (type-check)
        run: pnpm build

  copilot-review:
    name: Copilot CLI review and security scan
    needs: quality-checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack and install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@9.12.3 --activate

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store/v3
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Copilot CLI
        run: npm install -g @github/copilot

      - name: Run dependency vulnerability scan
        run: node scripts/vulnerability-scan.js

      - name: Run secret scan
        id: secret-scan
        run: |
          set -euo pipefail
          node scripts/secret-scan.js || echo "secret_found=true" >> "$GITHUB_OUTPUT"

      - name: Block PR if secrets detected
        if: steps.secret-scan.outputs.secret_found == 'true'
        run: |
          echo "::error::Potential secrets detected in code changes. Review .github/secret-scan-report.json"
          exit 1

      - name: Copilot secret and security scan
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_MODEL: ${{ env.COPILOT_MODEL }}
        run: |
          set -euo pipefail

          # Generate fallback SARIF in case copilot scan fails or is unavailable
          FALLBACK_SARIF='{ "version": "2.1.0", "$schema": "https://json.schemastore.org/sarif-2.1.0.json", "runs": [ { "tool": { "driver": { "name": "GitHub Copilot", "version": "1.0.0" } }, "results": [] } ] }'

          if command -v copilot &> /dev/null; then
            if copilot scan > copilot-security.sarif 2>/dev/null || copilot scan --output sarif > copilot-security.sarif 2>/dev/null; then
              echo "âœ… copilot scan succeeded"
            else
              echo "âš ï¸ copilot scan failed or produced no output; using fallback"
              echo "$FALLBACK_SARIF" > copilot-security.sarif
            fi
          else
            echo "âš ï¸ copilot CLI not found; using fallback SARIF"
            echo "$FALLBACK_SARIF" > copilot-security.sarif
          fi

          test -s copilot-security.sarif || echo "$FALLBACK_SARIF" > copilot-security.sarif

      - name: Upload security findings
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: copilot-security.sarif
          category: copilot-security

      - name: Copilot agent review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_MODEL: ${{ env.COPILOT_MODEL }}
          AGENT_PATH: .github/agents/code-review.md
        run: |
          set -euo pipefail
          node scripts/copilot-agent-review.js

          cat copilot-review.json

      - name: Verify Copilot outputs
        run: |
          set -euo pipefail
          ls -al
          ls -al .github
          test -s copilot-review.json || { echo '::error::Missing copilot-review.json'; exit 1; }
          test -s copilot-security.sarif || { echo '::error::Missing copilot-security.sarif'; exit 1; }
          test -s .github/copilot-audit-report.json || { echo '::error::Missing .github/copilot-audit-report.json'; exit 1; }

      - name: Check for critical findings and block PR
        id: check-findings
        run: |
          set -euo pipefail
          CRITICAL=$(jq '.findings | map(select(.severity == "critical")) | length' copilot-review.json 2>/dev/null || echo 0)
          HIGH=$(jq '.findings | map(select(.severity == "high")) | length' copilot-review.json 2>/dev/null || echo 0)
          echo "critical_count=$CRITICAL" >> "$GITHUB_OUTPUT"
          echo "high_count=$HIGH" >> "$GITHUB_OUTPUT"
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical findings in Copilot review"
            exit 1
          fi
          echo "âœ… No critical findings (high: $HIGH)"

      - name: Post Copilot summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            const reviewPath = 'copilot-review.json'
            const auditPath = '.github/copilot-audit-report.json'

            const readJson = (filepath) => {
              if (!fs.existsSync(filepath)) return null
              try { return JSON.parse(fs.readFileSync(filepath, 'utf8')) } catch (e) { return null }
            }

            const review = readJson(reviewPath) || {}
            const audit = readJson(auditPath) || { severityCounts: {}, packageSummary: [] }

            const findings = Array.isArray(review.findings) ? review.findings : []
            const criticalCount = findings.filter((it) => it.severity?.toLowerCase() === 'critical').length
            const highCount = findings.filter((it) => it.severity?.toLowerCase() === 'high').length

            const severityCounts = audit.severityCounts || {}
            const pkgSummary = Array.isArray(audit.packageSummary) ? audit.packageSummary : []

            const severityRank = { unknown: 0, low: 1, medium: 2, high: 3, critical: 4 }
            pkgSummary.sort((a, b) => {
              const sa = severityRank[a.highestSeverity] || 0
              const sb = severityRank[b.highestSeverity] || 0
              if (sb !== sa) return sb - sa
              return (b.count || 0) - (a.count || 0)
            })

            let body = '## ğŸ¤– Copilot è‡ªå‹•åŒ–ç¨‹å¼ç¢¼å¯©æŸ¥\n\n'
            body += `- ğŸ”´ AI Critical findings: ${criticalCount}\n`
            body += `- ğŸŸ¡ AI High findings: ${highCount}\n`
            body += `- ğŸ“Š Dependency severity counts: ${JSON.stringify(severityCounts)}\n\n`

            if (findings.length > 0) {
              body += '### AI: ä¸»è¦å•é¡Œï¼ˆå‰ 5ï¼‰\n'
              findings.slice(0, 5).forEach((f) => {
                const loc = f.file ? `${f.file}:${f.line || ''}` : 'N/A'
                body += `- **${f.title || 'Issue'}** (${loc}) â€” ${f.description || ''}\n`
              })
              body += '\n'
            } else {
              body += 'æ²’æœ‰ç”± Copilot å›å ±çš„æ–°å¢å•é¡Œï¼ˆAIï¼‰ã€‚\n\n'
            }

            if (pkgSummary.length > 0) {
              body += '### ğŸ“¦ Top dependency risks\n'
              pkgSummary.slice(0, 10).forEach((p) => {
                const url = (p.urls && p.urls.length) ? ` ([details](${p.urls[0]}))` : ''
                body += `- **${p.name}** â€” ${p.highestSeverity} (${p.count})${url}\n  - versions: ${p.versions.slice(0,3).join(', ') || 'n/a'}\n`
              })
              if (audit.moreFindings) body += `\n_å¦å¤–æœ‰ ${audit.moreFindings} å€‹è¢«æˆªæ–·çš„ç™¼ç¾ã€‚_\n`
            } else {
              body += 'æ²’æœ‰åµæ¸¬åˆ°é«˜é¢¨éšªç›¸ä¾æ€§ã€‚\n'
            }

            body += '\n> å®Œæ•´è¼¸å‡ºè«‹æŸ¥çœ‹ workflow artifact `copilot-reports`ï¼ˆåŒ…å« `copilot-review.json`ã€`copilot-security.sarif`ã€`.github/copilot-audit-report.json`ï¼‰ã€‚'

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })

      - name: Upload Copilot reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: copilot-reports
          if-no-files-found: ignore
          path: |
            copilot-review.json
            copilot-security.sarif
            .github/copilot-audit-report.json
            .github/secret-scan-report.json
